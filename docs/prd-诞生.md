这份文档沉淀了 **Project SiliconMomo (硅基Momo)** 从 0 到 1 的完整技术演进过程。它不仅记录了代码的变迁，更记录了我们如何通过工程化思维，解决自动化与拟人化之间的矛盾。

---

# Project SiliconMomo：全链路拟人化社交智能体开发文档

**文档版本：** v1.0
**最后更新：** 2026-01-07
**项目代号：** SiliconMomo
**核心目标：** 构建一个基于 PC Web 端的自动化智能体，具备感知、思考、决策能力，模拟真实人类（人设：“Momo”）在社交平台上的生存与互动。

---

## 1. 项目初衷与技术选型 (Motivation & Tech Stack)

### 1.1 项目背景

我们旨在探索 **Agentic AI** 在复杂社交网络环境中的生存能力。区别于传统的“爬虫”或“群控脚本”，SiliconMomo 强调**“拟人化”**和**“认知能力”**。它不仅要“能操作”，还要“像人一样操作”，更要“像人一样思考”。

### 1.2 核心选型决策

在多轮讨论中，我们确定了以下技术栈及其背后的逻辑：

| 组件 | 选型 | 决策理由 |
| --- | --- | --- |
| **执行层** | **Playwright (Async)** | 相比 Selenium，Playwright 响应更快，对现代 SPA 页面支持更好，且支持 CDP 协议。异步架构 (Asyncio) 为未来的并发扩展留出空间。 |
| **连接模式** | **CDP (Connect Over CDP)** | **(关键转折)** 放弃 `browser.launch()` 自动启动模式，改为接管用户手动打开的 Chrome。这极大地降低了浏览器指纹风险，直接利用真实用户的 Cookie 和缓存，解决了复杂的登录验证码问题。 |
| **大脑层** | **GLM-4.6 (ZhipuAI)** | 国产大模型，具备优秀的中文理解能力，且 API 响应速度和成本在可控范围内。 |
| **调度层** | **Supervisor 模式** | 借鉴工厂管理模式，将“干活”与“纠错”分离，极大提升了系统的鲁棒性。 |

---

## 2. 系统核心功能 (Core Features)

### 2.1 基础生存能力

* **CDP 接管：** 能够连接到本地 9222 端口的 Chrome 浏览器，智能复用已打开的小红书标签页。
* **拟人化运动：** 摒弃机械的 `click()`，封装了 `HumanMotion` 类，实现**贝塞尔曲线鼠标轨迹**移动，以及非匀速、带惯性的**仿生滚动**。
* **环境自检：** 运行时实时监测 URL，防止页面偏离（如误入其他网站）。

### 2.2 认知与交互能力

* **视觉感知：** 能够提取帖子标题、正文内容。
* **智能决策：** 集成 GLM-4.6，根据帖子内容判断相关性（Target Topics）。
* **概率互动：**
* **浏览：** 随机时长停留，模拟阅读。
* **点赞/收藏：** 基于概率和内容质量触发。
* **评论：** 具备“激活输入框 -> 模拟打字 -> 发送”的完整链路。


* **搜索轮转：** 维护一个关键词池，每浏览 N 个帖子后自动切换搜索词，保持 Feed 流的新鲜度。

### 2.3 鲁棒性与可观测性

* **黑匣子 (Recorder)：** 全程记录结构化数据 (`report.json`)、文本日志 (`run.log`) 以及错误现场截图 (`error_*.png`)。
* **自我修复 (Self-Healing)：** 当发生点击失效、元素丢失或页面卡死时，系统能自动诊断并尝试修复（如刷新、回退、按 ESC）。

---

## 3. 迭代升级记录 (Iteration Log)

我们的开发经历了一个从“脚本”到“系统”的演变过程：

### v0.1：异步脚本原型

* **功能：** 实现了 `BrowserManager` 的基础封装，支持 `storage_state.json` 的保存与加载。
* **问题：** 发现单纯依赖 Cookie 文件存在“伪登录”风险（Cookie 在但 Token 过期），且容易被风控识别为机器人。

### v0.2：CDP 模式确立 (里程碑)

* **变革：** 彻底移除 `browser.launch()`，改为 `connect_over_cdp`。
* **收益：** 解决了验证码通过率低的问题，实现了“人机共生”——用户可以随时接管浏览器。

### v0.3：拟人化动作库

* **功能：** 引入 `human_motion.py`。
* **细节：** 实现了鼠标移动的随机抖动、过冲，以及滚动的随机停顿。

### v0.4：工厂流水线架构 (鲁棒性升级)

* **背景：** 发现脚本在网络波动或误操作（打开新 Tab）时容易崩盘。
* **重构：** 引入 **FSM (有限状态机)** 思想。
* **Worker:** 只负责执行原子操作。
* **Supervisor:** 负责异常捕获和调度。
* **RecoveryAgent:** 负责从错误中恢复（如刷新页面、关闭遮罩）。



### v0.5：接入大脑 (GLM-4)

* **功能：** 引入 `LLMClient`，对接智谱 AI。
* **细节：** 实现了“读取 -> Prompt工程 -> JSON解析”的链路。

### v0.6：人性化逻辑 (Lazy Mode)

* **背景：** 发现“逢贴必评”太假，且评论框选择器有坑。
* **优化：**
1. **漏斗模型：** 引入“懒人模式” (Lazy) 和“深思模式” (Deep)。只有概率命中且内容相关时才评论。
2. **评论修复：** 增加了对 `.inner-when-not-active`（未激活评论框）的处理逻辑。



---

## 4. 关键设计模式 (Design Patterns)

项目中应用了多种软件工程设计模式，以保证代码的可维护性：

1. **工厂模式 (Factory / Assembly Line)：**
* 将爬虫流程比作流水线，`Supervisor` 是管理者，`Worker` 是工人，`Recovery` 是维修工。这种分离使得单一职责非常清晰。


2. **策略模式 (Strategy Pattern)：**
* 在 `RecoveryAgent` 中，针对不同的错误（URL 偏离、元素丢失、超时），采用不同的修复策略（刷新、跳转、按 ESC）。


3. **依赖注入 (Dependency Injection)：**
* `Recorder` (日志记录器) 在 `main.py` 中初始化，并层层传递给 `BrowserManager`、`ActionExecutor` 和 `LLMClient`。保证了全局日志的一致性。


4. **漏斗模型 (Funnel Model)：**
* 在互动逻辑中，采用 `浏览 -> 动脑(40%) -> 表达(70%)` 的层级概率过滤，模拟真实人类的注意力稀缺性。



---

## 5. 潜在问题与风险 (Known Issues & Risks)

尽管系统已经较为完善，但仍存在以下风险点：

1. **DOM 变动风险：**
* 小红书的前端代码更新频繁（特别是类名混淆）。目前的 `SELECTORS` 字典虽然集中管理，但仍需人工定期维护。
* *未来方案：* 引入视觉识别模型（如 YOLO 或基于 LLM 的视觉定位），摆脱对 CSS 选择器的依赖。


2. **内容风控：**
* 虽然接入了 GLM，但如果 LLM 生成了敏感词，仍可能导致账号禁言。
* *应对：* 需要在 Prompt 中加入更严格的审查指令，或建立本地敏感词库。


3. **行为指纹：**
* 虽然使用了贝塞尔曲线，但长时间（>3小时）的连续操作仍可能被大数据模型判定为异常。
* *应对：* 严格遵守 `RUN_DURATION` 限制，并建议配合人工手动操作混合使用。



---

## 6. 总结

SiliconMomo 项目展示了一个**从“自动化脚本”向“智能体 (Agent)”进化**的完整范例。

* **技术上**，我们证明了 CDP + Playwright + LLM 是目前构建 Web 智能体的高效组合。
* **架构上**，Supervisor + Recovery 的模式为长时间运行任务提供了极高的稳定性保障。
* **逻辑上**，概率漏斗与拟人化策略，让机器人的行为边界变得模糊，更难以被识别。

**Next Step:**
该项目已具备 MVP (Minimum Viable Product) 的所有特征。接下来的重点是**长期运行测试**（Long-running Test）与**策略微调**。