# SiliconMomo 测试运行指南

## 📋 前置准备

### 1. 安装依赖

```bash
# 进入项目目录
cd /Users/zhangqilai/project/vibe-code-100-projects/guiji/SiliconMomo

# 安装Python依赖
pip install playwright zai

# 安装Playwright浏览器
playwright install chromium
```

### 2. 检查配置

确认 `config/settings.py` 中的配置：

```python
CDP_URL = "http://localhost:9222"  # CDP调试端口
ZHIPU_AI_KEY = "你的智谱AI密钥"      # 需要替换为真实密钥
RUN_DURATION = 86400  # 24小时（测试时可以改小，如3600=1小时）
```

---

## 🚀 启动步骤

### 步骤1：启动Chrome浏览器（CDP模式）

**Mac系统：**
```bash
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9222 \
  --user-data-dir="/tmp/chrome-debug"
```

**或者使用环境变量：**
```bash
export XHS_CDP_URL="http://localhost:9222"
```

**Windows系统：**
```cmd
"C:\Program Files\Google\Chrome\Application\chrome.exe" ^
  --remote-debugging-port=9222 ^
  --user-data-dir="C:\temp\chrome-debug"
```

**Linux系统：**
```bash
google-chrome \
  --remote-debugging-port=9222 \
  --user-data-dir="/tmp/chrome-debug"
```

### 步骤2：登录小红书

1. 在启动的Chrome浏览器中，访问 `https://www.xiaohongshu.com`
2. **手动登录**你的小红书账号
3. 确保登录状态正常（能看到首页内容）

> ⚠️ **重要**：必须在启动程序前完成登录，程序会复用这个浏览器会话。

### 步骤3：运行主程序

```bash
# 在项目根目录
python main.py
```

或者：

```bash
python -m main
```

---

## 🧪 测试模式建议

### 模式1：快速测试（推荐首次运行）

**修改配置** `config/settings.py`：
```python
RUN_DURATION = 300  # 5分钟测试
```

**运行：**
```bash
python main.py
```

**观察：**
- 是否成功连接浏览器
- 是否开始搜索和浏览
- 是否记录素材到知识库
- 是否有错误日志

### 模式2：功能测试（30分钟）

**修改配置**：
```python
RUN_DURATION = 1800  # 30分钟
INSPIRATION_THRESHOLD = 2  # 降低阈值，更快触发创作
```

**运行：**
```bash
python main.py
```

**观察：**
- 浏览互动是否正常
- 是否积累高质量素材
- 是否触发创作流程
- 是否生成草稿

### 模式3：完整测试（24小时）

**保持默认配置**：
```python
RUN_DURATION = 86400  # 24小时
INSPIRATION_THRESHOLD = 3  # 正常阈值
```

**运行：**
```bash
# 建议在后台运行
nohup python main.py > output.log 2>&1 &
```

**观察：**
- 持续运营是否稳定
- 维修工是否正常修复错误
- 创作+发帖是否按计划执行

---

## 📊 观察日志

### 控制台输出

程序运行时会输出日志，关键信息：

```
👨‍✈️ [车间主任] 24小时运营启动，维修工待命
🔄 [轮转] 切换关键词: 发疯文学
🧠 [模式] 深度分析 (调用LLM)
💾 [知识库] +1 新素材: 周一哪有不疯的...
🎨 [创作流程] 开始创作+发帖流程...
✍️ [笔杆子] 正在仿写创作...
🎨 [美术师] 收到需求: cinematic lighting...
📤 [发布员] 开始发布: 《周一哪有不疯的...》
✅ 维修成功，继续运营
```

### 日志文件

程序会在 `core/recorder.py` 中保存日志，检查：
- 控制台输出
- 可能的错误日志文件（如果有配置）

---

## 🔍 测试检查清单

### ✅ 基础功能测试

- [ ] **浏览器连接**
  - 启动Chrome CDP模式
  - 运行程序，检查是否成功连接

- [ ] **搜索功能**
  - 检查是否开始搜索"发疯文学"等关键词
  - 检查是否正常浏览帖子

- [ ] **LLM分析**
  - 检查是否调用LLM分析帖子
  - 检查是否正确识别情感内容
  - 检查是否标记高质量素材

- [ ] **知识库记录**
  - 检查 `data/inspiration.json` 是否有新素材
  - 检查素材是否包含 `is_high_quality` 和 `style_hint` 字段

### ✅ 创作功能测试

- [ ] **触发创作**
  - 积累3个高质量素材后，检查是否触发创作
  - 检查是否从素材库选择素材

- [ ] **文案生成**
  - 检查是否生成文案
  - 检查文案风格是否符合（发疯/治愈/清醒/共情）

- [ ] **图片生成**
  - 检查是否打开即梦工作台
  - 检查是否生成图片
  - 检查图片是否保存到 `assets/images/`

- [ ] **草稿保存**
  - 检查 `data/drafts.json` 是否有新草稿
  - 检查草稿是否包含完整信息

### ✅ 发布功能测试

- [ ] **发布流程**
  - 在发布时间点（8/12/21点），检查是否尝试发布
  - 检查是否填写标题和内容
  - 检查是否上传图片

- [ ] **发布标记**
  - 发布成功后，检查草稿是否标记为 `published`

### ✅ 容错功能测试

- [ ] **错误恢复**
  - 模拟错误（如网络中断），检查维修工是否介入
  - 检查是否执行深度恢复
  - 检查是否继续循环（不退出）

- [ ] **持续运营**
  - 检查是否24小时持续运行
  - 检查是否只有浏览器断开或用户中断才退出

---

## 🐛 常见问题排查

### 问题1：连接浏览器失败

**错误信息：**
```
❌ 连接失败: ...
```

**解决方案：**
1. 检查Chrome是否以CDP模式启动
2. 检查端口9222是否被占用：`lsof -i :9222`
3. 确认 `config/settings.py` 中的 `CDP_URL` 正确

### 问题2：未登录小红书

**错误信息：**
```
需要登录，请在浏览器中手动完成登录
```

**解决方案：**
1. 在Chrome浏览器中手动登录小红书
2. 确保登录状态正常
3. 重新运行程序

### 问题3：LLM调用失败

**错误信息：**
```
🧠 [大脑] 思考失败: ...
```

**解决方案：**
1. 检查 `ZHIPU_AI_KEY` 是否正确
2. 检查网络连接
3. 检查智谱AI账户余额

### 问题4：即梦生图失败

**错误信息：**
```
🎨 [美术师] 作画流程异常: ...
```

**解决方案：**
1. 检查是否在浏览器中登录了即梦
2. 检查即梦网站是否可访问
3. 检查选择器是否更新（小红书可能改版）

### 问题5：发布失败

**错误信息：**
```
📤 [发布员] 发布失败: ...
```

**解决方案：**
1. 检查是否在发布时间点（8/12/21点）
2. 检查小红书发布页面是否可访问
3. 检查选择器是否更新

---

## 📝 测试数据检查

### 检查知识库

```bash
# 查看素材库
cat data/inspiration.json | python -m json.tool

# 统计高质量素材数量
cat data/inspiration.json | python -c "
import json, sys
data = json.load(sys.stdin)
hq = [i for i in data if i.get('ai_analysis', {}).get('is_high_quality')]
print(f'高质量素材: {len(hq)}')
"
```

### 检查草稿库

```bash
# 查看草稿
cat data/drafts.json | python -m json.tool

# 统计待发布草稿
cat data/drafts.json | python -c "
import json, sys
data = json.load(sys.stdin)
ready = [d for d in data if d.get('status') == 'ready_to_publish']
print(f'待发布草稿: {len(ready)}')
"
```

### 检查图片

```bash
# 查看生成的图片
ls -lh assets/images/
```

---

## 🎯 测试建议

### 首次测试（5分钟）

1. 修改 `RUN_DURATION = 300`
2. 启动Chrome CDP模式
3. 登录小红书
4. 运行 `python main.py`
5. 观察控制台输出
6. 检查是否有错误

### 功能测试（30分钟）

1. 修改 `RUN_DURATION = 1800`
2. 修改 `INSPIRATION_THRESHOLD = 2`（更快触发）
3. 运行程序
4. 等待触发创作流程
5. 检查草稿和图片

### 完整测试（24小时）

1. 保持默认配置
2. 后台运行：`nohup python main.py > output.log 2>&1 &`
3. 定期检查日志
4. 检查知识库和草稿库增长情况

---

## 📞 获取帮助

如果遇到问题：

1. **查看日志**：检查控制台输出和错误信息
2. **检查配置**：确认 `config/settings.py` 配置正确
3. **检查依赖**：确认所有依赖已安装
4. **检查浏览器**：确认Chrome CDP模式正常
5. **检查登录**：确认小红书已登录

---

**祝测试顺利！** 🚀
