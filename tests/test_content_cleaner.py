#!/usr/bin/env python3
"""
å†…å®¹æ¸…æ´—å™¨æµ‹è¯•è„šæœ¬

æ¼”ç¤ºå¦‚ä½•å°† AI ç”Ÿæˆçš„ Markdown å†…å®¹è½¬æ¢ä¸ºå°çº¢ä¹¦å‹å¥½çš„çº¯æ–‡æœ¬æ ¼å¼
"""

import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from core.content_cleaner import ContentCleaner


def test_content_cleaning():
    """æµ‹è¯•å†…å®¹æ¸…æ´—åŠŸèƒ½"""

    # æµ‹è¯•ç”¨ä¾‹ï¼šåŒ…å«å„ç§ Markdown æ ¼å¼çš„å†…å®¹
    test_cases = [
        {
            "name": "ç²—ä½“æ–‡æœ¬",
            "input": "**5æ¬¾AIæ‘˜è¦ç¥å™¨**âš¡æ•ˆç‡ç¿»å€ï¼æ‰“å·¥äººå¿…çœ‹ï¼",
            "expected": "5æ¬¾AIæ‘˜è¦ç¥å™¨âš¡æ•ˆç‡ç¿»å€ï¼æ‰“å·¥äººå¿…çœ‹ï¼"
        },
        {
            "name": "æ ‡é¢˜ç¬¦å·",
            "input": "# AIå·¥å…·æ¨è\n## å­æ ‡é¢˜",
            "expected": "AIå·¥å…·æ¨è\nå­æ ‡é¢˜"
        },
        {
            "name": "åˆ—è¡¨ç¬¦å·",
            "input": "- ç¬¬ä¸€é¡¹\n- ç¬¬äºŒé¡¹\nâ€¢ ç¬¬ä¸‰é¡¹",
            "expected": "ç¬¬ä¸€é¡¹\nç¬¬äºŒé¡¹\nç¬¬ä¸‰é¡¹"
        },
        {
            "name": "æ··åˆæ ¼å¼",
            "input": """
# AIå·¥å…·æ¨è

**5æ¬¾AIæ‘˜è¦ç¥å™¨**âš¡æ•ˆç‡ç¿»å€ï¼

è¿˜åœ¨ä¸ºé•¿æ–‡ã€é•¿è§†é¢‘å‘æ„å—ï¼ŸğŸ¤¯

1ï¸âƒ£ **Kimi Chat**ï¼š20ä¸‡å­—é•¿æ–‡ä¸€é”®æ€»ç»“ ğŸ“„
2ï¸âƒ£ **è±†åŒ…**ï¼šç½‘é¡µã€è§†é¢‘éƒ½æ‹¿ä¸‹ ğŸ¬
3ï¸âƒ£ **Perplexity AI**ï¼šä¿¡æ¯æ¥æºä¸€ç›®äº†ç„¶ ğŸ”

èµ¶ç´§ç ä½ï¼Œé«˜æ•ˆå·¥ä½œå°±é å®ƒä»¬äº†ï¼ğŸ’ª

#AIå·¥å…· #æ•ˆç‡ç¥å™¨ #æ‰“å·¥äººå¿…å¤‡
            """
        }
    ]

    print("=" * 80)
    print("ğŸ§ª å†…å®¹æ¸…æ´—å™¨æµ‹è¯•")
    print("=" * 80)

    for i, test_case in enumerate(test_cases, 1):
        print(f"\nã€æµ‹è¯• {i}ã€‘{test_case['name']}")
        print("-" * 80)

        input_text = test_case['input'].strip()
        output_text = ContentCleaner.clean_for_xiaohongshu(input_text)

        print(f"è¾“å…¥:\n{input_text}\n")
        print(f"è¾“å‡º:\n{output_text}\n")

        if 'expected' in test_case:
            expected = test_case['expected'].strip()
            if output_text.strip() == expected:
                print("âœ… æµ‹è¯•é€šè¿‡")
            else:
                print(f"âŒ æµ‹è¯•å¤±è´¥")
                print(f"æœŸæœ›: {expected}")
        else:
            print("âœ… æ¸…æ´—å®Œæˆ")

    # æµ‹è¯•çœŸå®è‰ç¨¿å†…å®¹
    print("\n" + "=" * 80)
    print("ğŸ“ çœŸå®è‰ç¨¿æµ‹è¯•")
    print("=" * 80)

    real_draft = {
        "title": "ğŸ§  åˆ«å†ç¥åŒ–AIäº†ï¼ŒèŠèŠå¤§æ¨¡å‹çš„åº•å±‚é€»è¾‘",
        "content": """èŠå¤§æ¨¡å‹å‰ï¼Œå…ˆåˆ«æŠŠå®ƒæƒ³å¾—å¤ªç„ä¹ã€‚å®ƒä¸æ˜¯é­”æ³•ï¼Œæ˜¯æ•°å­¦ã€‚

æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªè¯»è¿‡å…¨ç½‘æ‰€æœ‰æ–‡æœ¬çš„ã€Œè¶…çº§å®ä¹ ç”Ÿã€ã€‚

å®ƒçš„æ ¸å¿ƒèƒ½åŠ›ï¼Œæ¥è‡ªã€Œé¢„è®­ç»ƒã€ã€‚ç®€å•è¯´ï¼Œå°±æ˜¯æŠŠäº’è”ç½‘ä¸Šå‡ ä¹æ‰€æœ‰çš„ä¹¦ç±ã€æ–‡ç« ã€ä»£ç ã€å¯¹è¯...éƒ½ã€Œå–‚ã€ç»™å®ƒåƒã€‚ğŸ“š

ç„¶åå‘¢ï¼Ÿå®ƒåªåšä¸€ä»¶äº‹ï¼šé¢„æµ‹ä¸‹ä¸€ä¸ªè¯ã€‚ğŸ¤” ä½ è¾“å…¥"ä»Šå¤©å¤©æ°”ä¸é”™"ï¼Œå®ƒä¼šè®¡ç®—æ¦‚ç‡æœ€é«˜çš„ä¸‹ä¸€ä¸ªè¯æ˜¯"æˆ‘ä»¬å»..."è¿˜æ˜¯"é€‚åˆ..."ã€‚

é‚£ä¸ºä»€ä¹ˆå«ã€Œå¤§ã€æ¨¡å‹ï¼Ÿå› ä¸ºå®ƒçš„å‚æ•°é‡æå¤§ï¼Œè¾¾åˆ°ç™¾äº¿ã€åƒäº¿ç”šè‡³ä¸‡äº¿çº§åˆ«ã€‚ğŸ§  è¿™å°±åƒå¤§è„‘çš„ç¥ç»å…ƒè¿æ¥ï¼Œè¶Šå¤šï¼Œå¤„ç†å¤æ‚ä¿¡æ¯çš„èƒ½åŠ›è¶Šå¼ºã€‚

æ‰€ä»¥ï¼Œåˆ«å†æŠŠå®ƒå½“æˆä¸€ä¸ªæœ‰æ„è¯†çš„"ç”Ÿå‘½ä½“"ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæå…¶å¤æ‚çš„æ¦‚ç‡è®¡ç®—å™¨ã€‚ä¸€ä¸ªåœ¨æ•°æ®æµ·æ´‹é‡Œå¯»æ‰¾æœ€ä¼˜è§£çš„æš´åŠ›ç¾å­¦æœºå™¨ã€‚âš™ï¸

æ¶ˆåŒ–ä¸€ä¸‹ã€‚ä¸‹ç¯‡èŠæç¤ºè¯å·¥ç¨‹ã€‚""",
        "tags": ["#å¤§æ¨¡å‹", "#AI", "#äººå·¥æ™ºèƒ½", "#æŠ€æœ¯ç§‘æ™®", "#å¹²è´§åˆ†äº«", "#MomoèŠæŠ€æœ¯"]
    }

    print("\nã€åŸå§‹è‰ç¨¿ã€‘")
    print(f"æ ‡é¢˜: {real_draft['title']}")
    print(f"å†…å®¹: {real_draft['content'][:100]}...")
    print(f"æ ‡ç­¾: {' '.join(real_draft['tags'])}")

    print("\nã€æ¸…æ´—åã€‘")
    cleaned_title = ContentCleaner.clean_for_xiaohongshu(real_draft['title'])
    cleaned_content = ContentCleaner.clean_for_xiaohongshu(real_draft['content'])

    print(f"æ ‡é¢˜: {cleaned_title}")
    print(f"å†…å®¹: {cleaned_content[:100]}...")
    print(f"æ ‡ç­¾: {' '.join(real_draft['tags'])}")

    # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
    if cleaned_title != real_draft['title'] or cleaned_content != real_draft['content']:
        print("\nâœ… æ¸…æ´—æ£€æµ‹åˆ° Markdown æ ¼å¼å¹¶å·²ç§»é™¤")
    else:
        print("\nâ„¹ï¸  å†…å®¹å·²ç»å¾ˆå¹²å‡€ï¼Œæ— éœ€æ¸…æ´—")


def show_cleaning_details():
    """æ˜¾ç¤ºæ¸…æ´—è§„åˆ™çš„è¯¦ç»†è¯´æ˜"""

    print("\n" + "=" * 80)
    print("ğŸ“– æ¸…æ´—è§„åˆ™è¯´æ˜")
    print("=" * 80)

    rules = """
    1. å»é™¤ç²—ä½“ç¬¦å· (**æ–‡æœ¬**)
       ç¤ºä¾‹: **AIå·¥å…·æ¨è** â†’ AIå·¥å…·æ¨è

    2. å»é™¤æ ‡é¢˜ç¬¦å· (# æ ‡é¢˜)
       ç¤ºä¾‹: # è¿™æ˜¯ä¸€çº§æ ‡é¢˜ â†’ è¿™æ˜¯ä¸€çº§æ ‡é¢˜
             ## è¿™æ˜¯äºŒçº§æ ‡é¢˜ â†’ è¿™æ˜¯äºŒçº§æ ‡é¢˜

    3. å»é™¤åˆ—è¡¨ç¬¦å· (- æˆ– â€¢)
       ç¤ºä¾‹: - ç¬¬ä¸€é¡¹ â†’ ç¬¬ä¸€é¡¹
             â€¢ ç¬¬äºŒé¡¹ â†’ ç¬¬äºŒé¡¹

    4. å»é™¤ä»£ç å—ç¬¦å· (```)
       ç¤ºä¾‹: ```ä»£ç ``` â†’ (ç§»é™¤)

    5. å»é™¤è¡Œå†…ä»£ç ç¬¦å· (`ä»£ç `)
       ç¤ºä¾‹: `ä»£ç ` â†’ ä»£ç 

    6. å»é™¤é“¾æ¥æ ¼å¼ [æ–‡å­—](é“¾æ¥)
       ç¤ºä¾‹: [ç‚¹å‡»è¿™é‡Œ](https://example.com) â†’ ç‚¹å‡»è¿™é‡Œ

    7. è§„èŒƒåŒ–ç©ºæ ¼å’Œæ¢è¡Œ
       - å¤šä¸ªç©ºæ ¼ â†’ å•ä¸ªç©ºæ ¼
       - å¤šä¸ªæ¢è¡Œ â†’ æœ€å¤šä¸¤ä¸ªæ¢è¡Œï¼ˆä¿ç•™æ®µè½ï¼‰

    8. ä¿ç•™è¡¨æƒ…ç¬¦å·
       æ‰€æœ‰å°çº¢ä¹¦å¸¸ç”¨è¡¨æƒ…ç¬¦å·éƒ½ä¼šè¢«ä¿ç•™

    9. ä¿ç•™æ ‡ç­¾
       #æ ‡ç­¾ æ ¼å¼ä¼šè¢«ä¿ç•™
    """
    print(rules)


if __name__ == "__main__":
    # è¿è¡Œæµ‹è¯•
    test_content_cleaning()

    # æ˜¾ç¤ºæ¸…æ´—è§„åˆ™
    show_cleaning_details()

    print("\n" + "=" * 80)
    print("âœ… æµ‹è¯•å®Œæˆ")
    print("=" * 80)
